<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: CleanSweep::PurgeRunner
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!CleanSweep/PurgeRunner.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../CleanSweep.html" title="CleanSweep (module)">CleanSweep</a></span></span>
     &raquo; 
    <span class="title">PurgeRunner</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: CleanSweep::PurgeRunner
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">CleanSweep::PurgeRunner</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="PurgeRunner/Logging.html" title="CleanSweep::PurgeRunner::Logging (module)">Logging</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/clean_sweep/purge_runner.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This is a utility built to mimic some of the features of the pt_archive
script to make really big purges go faster with no production impact.</p>

<p>It uses a strategy of descending an index, querying for purgeable ids and
then deleting them in batches.</p>

<h3 id="label-Required+Options">Required Options</h3>
<dl class="rdoc-list label-list"><dt>:model
<dd>
<p>Required: the Active Record model for the table being purged or copied from</p>
</dd></dl>

<h3 id="label-Optional+Options">Optional Options</h3>
<dl class="rdoc-list label-list"><dt>:chunk_size
<dd>
<p>The number of rows to copy in each block.  Defaults to 500.</p>
</dd><dt>:index
<dd>
<p>The index to traverse in ascending order doing the purge.  Rows are read in
the order of the index, which must be a btree index.  If not specified,
<code>PRIMARY</code> is assumed.</p>
</dd><dt>:reverse
<dd>
<p>Traverse the index in reverse order.  For example, if your index is on
<code>account_id</code>, <code>timestamp</code>, this option will move
through the rows starting at the highest account number, then move through
timestamps starting with the most recent.</p>
</dd><dt>:first_only
<dd>
<p>Traverse only the first column of the index, and do so inclusively using
the <code>&amp;gt;=</code> operator instead of the strict
<code>&amp;gt;</code> operator.  This is important if the index is not
unique and there are a lot of duplicates.  Otherwise the delete could miss
rows.  Not allowed in copy mode because you&#39;d be inserting duplicate
rows.</p>
</dd><dt>:dry_run
<dd>
<p>Print out the queries that are going to be used.  You should run explain on
these.</p>
</dd><dt>:stop_after
<dd>
<p>The operation will end after copying this many rows.</p>
</dd><dt>:report
<dd>
<p>Specify an interval in seconds between status messages being printed out.</p>
</dd><dt>:logger
<dd>
<p>The log instance to use.  Defaults to the
<code>ActiveRecord::Base.logger</code> if not nil, otherwise it uses
_$stdout_</p>
</dd><dt>:dest_model
<dd>
<p>Specifies the model for the delete operation, or the copy operation if in
copy mode. When this option is present nothing is deleted in the model
table.  Instead, rows are either inserted into this table or deleted from
this table. The columns in this model must include the primary key columns
found in the source model.  If they have different names you need to
specify them with the <code>dest_columns</code> option.</p>
</dd><dt>:copy_only
<dd>
<p>Specifies copy mode, where rows are inserted into the destination table
instead of deleted from the model table. By default, only columns in the
named index and primary key are copied but these can be augmented with
columns in the <code>copy_columns</code> option.</p>
</dd><dt>:dest_columns
<dd>
<p>This is a map of column names in the model to column names in the dest
model when the corresponding models differ.  Only column names that are
different need to be specified. For instance your table of account ids
might have <code>account_id</code> as the primary key column, but you want
to delete rows in the accounts table where the account id is the column
named <code>id</code></p>
</dd><dt>:copy_columns
<dd>
<p>Extra columns to add when copying to a dest model.</p>
</dd></dl>

<h3 id="label-Safety+thresholds">Safety thresholds</h3>
<dl class="rdoc-list label-list"><dt>:sleep
<dd>
<p>Time in seconds to sleep between each chunk.</p>
</dd><dt>:max_history
<dd>
<p>The history list size (if available) is checked every 5 minutes and if it
exceeds this size the purge will pause until the history list is below 90%
of this value.</p>
</dd><dt>:max_repl_lag
<dd>
<p>The maximum length of the replication lag.  Checked every 5 minutes and if
exceeded the purge pauses until the replication lag is below 90% of this
value.</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="PurgeRunner/Logging.html" title="CleanSweep::PurgeRunner::Logging (module)">Logging</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="PurgeRunner/MysqlStatus.html" title="CleanSweep::PurgeRunner::MysqlStatus (class)">MysqlStatus</a></span>
    
  
</p>




  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#mysql_status-instance_method" title="#mysql_status (instance method)">- (Object) <strong>mysql_status</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This helps us track the state of replication and history list and pause if
necessary.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#copy_mode%3F-instance_method" title="#copy_mode? (instance method)">- (Boolean) <strong>copy_mode?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#execute_in_batches-instance_method" title="#execute_in_batches (instance method)">- (Object) <strong>execute_in_batches</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Execute the purge in chunks according to the parameters given on instance
creation.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (PurgeRunner) <strong>initialize</strong>(options = {}) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of PurgeRunner.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#print_queries-instance_method" title="#print_queries (instance method)">- (Object) <strong>print_queries</strong>(io) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sleep-instance_method" title="#sleep (instance method)">- (Object) <strong>sleep</strong>(duration) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="PurgeRunner/Logging.html" title="CleanSweep::PurgeRunner::Logging (module)">Logging</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="PurgeRunner/Logging.html#format-instance_method" title="CleanSweep::PurgeRunner::Logging#format (method)">#format</a></span>, <span class='object_link'><a href="PurgeRunner/Logging.html#log-instance_method" title="CleanSweep::PurgeRunner::Logging#log (method)">#log</a></span>, <span class='object_link'><a href="PurgeRunner/Logging.html#report-instance_method" title="CleanSweep::PurgeRunner::Logging#report (method)">#report</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="CleanSweep::PurgeRunner (class)">PurgeRunner</a></span></tt>) <strong>initialize</strong>(options = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of PurgeRunner</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clean_sweep/purge_runner.rb', line 80</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@model</span>     <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:model</span><span class='rbracket'>]</span> <span class='kw'>or</span> <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>source model class required</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@limit</span>            <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:chunk_size</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>500</span>

  <span class='ivar'>@target_model</span>     <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:dest_model</span><span class='rbracket'>]</span>
  <span class='ivar'>@stop_after</span>       <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:stop_after</span><span class='rbracket'>]</span>
  <span class='ivar'>@report_interval</span>  <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:report</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>10</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span>
  <span class='ivar'>@logger</span>           <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:logger</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span> <span class='op'>||</span> <span class='const'>Logger</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
  <span class='ivar'>@dry_run</span>          <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:dry_run</span><span class='rbracket'>]</span>
  <span class='ivar'>@sleep</span>            <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:sleep</span><span class='rbracket'>]</span>

  <span class='ivar'>@max_history</span>      <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:max_history</span><span class='rbracket'>]</span>
  <span class='ivar'>@max_repl_lag</span>     <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:max_repl_lag</span><span class='rbracket'>]</span>

  <span class='ivar'>@copy_mode</span>        <span class='op'>=</span> <span class='ivar'>@target_model</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:copy_only</span><span class='rbracket'>]</span>

  <span class='ivar'>@table_schema</span>     <span class='op'>=</span> <span class='const'>CleanSweep</span><span class='op'>::</span><span class='const'>TableSchema</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='ivar'>@model</span><span class='comma'>,</span>
                                                  <span class='label'>key_name:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:index</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                                  <span class='label'>ascending:</span> <span class='op'>!</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:reverse</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                                  <span class='label'>extra_columns:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:copy_columns</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                                  <span class='label'>first_only:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:first_only</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                                  <span class='label'>dest_model:</span> <span class='ivar'>@target_model</span><span class='comma'>,</span>
                                                  <span class='label'>dest_columns:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:dest_columns</span><span class='rbracket'>]</span>

  <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@max_history</span> <span class='op'>||</span> <span class='ivar'>@max_repl_lag</span><span class='rparen'>)</span>
    <span class='ivar'>@mysql_status</span> <span class='op'>=</span> <span class='const'>CleanSweep</span><span class='op'>::</span><span class='const'>PurgeRunner</span><span class='op'>::</span><span class='const'>MysqlStatus</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='label'>model:</span> <span class='ivar'>@model</span><span class='comma'>,</span>
                                                             <span class='label'>max_history:</span> <span class='ivar'>@max_history</span><span class='comma'>,</span>
                                                             <span class='label'>max_repl_lag:</span> <span class='ivar'>@max_repl_lag</span><span class='comma'>,</span>
                                                             <span class='label'>check_period:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:check_period</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                                            <span class='label'>logger:</span> <span class='ivar'>@logger</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You can&#39;t copy rows from a table into itself</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@model</span> <span class='op'>==</span> <span class='ivar'>@target_model</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>An index is required in copy mode</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_traversing_key'>traversing_key</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_only option not allowed in copy mode</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_first_only?'>first_only?</span>

  <span class='ivar'>@report_interval_start</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>

  <span class='ivar'>@query</span>                 <span class='op'>=</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_initial_scope'>initial_scope</span><span class='period'>.</span><span class='id identifier rubyid_limit'>limit</span><span class='lparen'>(</span><span class='ivar'>@limit</span><span class='rparen'>)</span>

  <span class='ivar'>@query</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='ivar'>@query</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="mysql_status-instance_method">
  
    - (<tt>Object</tt>) <strong>mysql_status</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This helps us track the state of replication and history list and pause if
necessary</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clean_sweep/purge_runner.rb', line 78</span>

<span class='kw'>def</span> <span class='id identifier rubyid_mysql_status'>mysql_status</span>
  <span class='ivar'>@mysql_status</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="copy_mode?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>copy_mode?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


124
125
126</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clean_sweep/purge_runner.rb', line 124</span>

<span class='kw'>def</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span>
  <span class='ivar'>@copy_mode</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="execute_in_batches-instance_method">
  
    - (<tt>Object</tt>) <strong>execute_in_batches</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Execute the purge in chunks according to the parameters given on instance
creation. Will raise <code>CleanSweep::PurgeStopped</code> if a
<code>stop_after</code> option was provided and that limit is hit.</p>

<p>Returns the number of rows copied or deleted.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clean_sweep/purge_runner.rb', line 134</span>

<span class='kw'>def</span> <span class='id identifier rubyid_execute_in_batches'>execute_in_batches</span>

  <span class='kw'>if</span> <span class='ivar'>@dry_run</span>
    <span class='id identifier rubyid_print_queries'>print_queries</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='int'>0</span>
  <span class='kw'>end</span>

  <span class='ivar'>@start</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='id identifier rubyid_verb'>verb</span> <span class='op'>=</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>copying</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>purging</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>starting: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_verb'>verb</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> records in batches of </span><span class='embvar'>#</span><span class='ivar'>@limit</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@target_model</span><span class='period'>.</span><span class='id identifier rubyid_table_name'>table_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span>


  <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:info</span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sleeping </span><span class='embexpr_beg'>#{</span><span class='ivar'>@sleep</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds between purging</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@sleep</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_copy_mode?'>copy_mode?</span>
  <span class='ivar'>@total_deleted</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='comment'># Iterate through the rows in limit chunks
</span>  <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:debug</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>find rows: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@query</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_level'>level</span> <span class='op'>==</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>

  <span class='ivar'>@mysql_status</span><span class='period'>.</span><span class='id identifier rubyid_check!'>check!</span> <span class='kw'>if</span> <span class='ivar'>@mysql_status</span>

  <span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='const'>NewRelic</span><span class='op'>::</span><span class='const'>Agent</span><span class='period'>.</span><span class='id identifier rubyid_with_database_metric_name'>with_database_metric_name</span><span class='lparen'>(</span><span class='ivar'>@model</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SELECT</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='ivar'>@model</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_select_rows'>select_rows</span> <span class='ivar'>@query</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span>
  <span class='kw'>end</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='op'>!</span><span class='ivar'>@stop_after</span> <span class='op'>||</span> <span class='ivar'>@total_deleted</span> <span class='op'>&lt;</span> <span class='ivar'>@stop_after</span><span class='rparen'>)</span> <span class='kw'>do</span>
<span class='comment'>#      index_entrypoint_args = Hash[*@source_keys.zip(rows.last).flatten]
</span>    <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:debug</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_verb'>verb</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='embexpr_end'>}</span><span class='tstring_content'> records between </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> and </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_level'>level</span> <span class='op'>==</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
    <span class='id identifier rubyid_stopped'>stopped</span> <span class='op'>=</span> <span class='ivar'>@stop_after</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>+</span> <span class='ivar'>@total_deleted</span> <span class='op'>&gt;</span> <span class='ivar'>@stop_after</span>

    <span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span><span class='ivar'>@stop_after</span> <span class='op'>-</span> <span class='ivar'>@total_deleted</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_stopped'>stopped</span>
    <span class='id identifier rubyid_last_row'>last_row</span> <span class='op'>=</span> <span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span>
      <span class='id identifier rubyid_metric_op_name'>metric_op_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>INSERT</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_statement'>statement</span> <span class='op'>=</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_insert_statement'>insert_statement</span><span class='lparen'>(</span><span class='id identifier rubyid_rows'>rows</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_metric_op_name'>metric_op_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DELETE</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_statement'>statement</span> <span class='op'>=</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_delete_statement'>delete_statement</span><span class='lparen'>(</span><span class='id identifier rubyid_rows'>rows</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:debug</span><span class='comma'>,</span> <span class='id identifier rubyid_statement'>statement</span> <span class='kw'>if</span> <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_level'>level</span> <span class='op'>==</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
    <span class='id identifier rubyid_chunk_deleted'>chunk_deleted</span> <span class='op'>=</span> <span class='const'>NewRelic</span><span class='op'>::</span><span class='const'>Agent</span><span class='period'>.</span><span class='id identifier rubyid_with_database_metric_name'>with_database_metric_name</span><span class='lparen'>(</span><span class='lparen'>(</span><span class='ivar'>@target_model</span><span class='op'>||</span><span class='ivar'>@model</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_metric_op_name'>metric_op_name</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='lparen'>(</span><span class='ivar'>@target_model</span><span class='op'>||</span><span class='ivar'>@model</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span> <span class='id identifier rubyid_statement'>statement</span>
    <span class='kw'>end</span>

    <span class='ivar'>@total_deleted</span> <span class='op'>+=</span> <span class='id identifier rubyid_chunk_deleted'>chunk_deleted</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>CleanSweep</span><span class='op'>::</span><span class='const'>PurgeStopped</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>stopped after </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_verb'>verb</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@total_deleted</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@model</span><span class='embexpr_end'>}</span><span class='tstring_content'> records</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='ivar'>@total_deleted</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_stopped'>stopped</span>
    <span class='id identifier rubyid_q'>q</span> <span class='op'>=</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_scope_to_next_chunk'>scope_to_next_chunk</span><span class='lparen'>(</span><span class='ivar'>@query</span><span class='comma'>,</span> <span class='id identifier rubyid_last_row'>last_row</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span>
    <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:debug</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>find rows: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_q'>q</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_level'>level</span> <span class='op'>==</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>

    <span class='id identifier rubyid_sleep'>sleep</span> <span class='ivar'>@sleep</span> <span class='kw'>if</span> <span class='ivar'>@sleep</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_copy_mode?'>copy_mode?</span>
    <span class='ivar'>@mysql_status</span><span class='period'>.</span><span class='id identifier rubyid_check!'>check!</span> <span class='kw'>if</span> <span class='ivar'>@mysql_status</span>

    <span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='const'>NewRelic</span><span class='op'>::</span><span class='const'>Agent</span><span class='period'>.</span><span class='id identifier rubyid_with_database_metric_name'>with_database_metric_name</span><span class='lparen'>(</span><span class='ivar'>@model</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SELECT</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='ivar'>@model</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_select_rows'>select_rows</span><span class='lparen'>(</span><span class='id identifier rubyid_q'>q</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_report'>report</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_report'>report</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span>
    <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:info</span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>completed after </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_verb'>verb</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@total_deleted</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> records to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@target_model</span><span class='period'>.</span><span class='id identifier rubyid_table_name'>table_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_log'>log</span> <span class='symbol'>:info</span><span class='comma'>,</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>completed after </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_verb'>verb</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@total_deleted</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> records</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='ivar'>@total_deleted</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="print_queries-instance_method">
  
    - (<tt>Object</tt>) <strong>print_queries</strong>(io) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clean_sweep/purge_runner.rb', line 208</span>

<span class='kw'>def</span> <span class='id identifier rubyid_print_queries'>print_queries</span><span class='lparen'>(</span><span class='id identifier rubyid_io'>io</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Initial Query:</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_format_query'>format_query</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>    </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@query</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='ivar'>@model</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_select_rows'>select_rows</span> <span class='ivar'>@query</span><span class='period'>.</span><span class='id identifier rubyid_limit'>limit</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='comment'># Don&#39;t have any sample data to use for the sample queries, so use NULL values just
</span>    <span class='comment'># so the query will print out.
</span>    <span class='id identifier rubyid_rows'>rows</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='kw'>nil</span><span class='rbracket'>]</span> <span class='op'>*</span> <span class='int'>100</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Chunk Query:</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_format_query'>format_query</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>    </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_scope_to_next_chunk'>scope_to_next_chunk</span><span class='lparen'>(</span><span class='ivar'>@query</span><span class='comma'>,</span> <span class='id identifier rubyid_rows'>rows</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_sql'>to_sql</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_copy_mode?'>copy_mode?</span>
    <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Insert Statement:</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_format_query'>format_query</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>    </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_insert_statement'>insert_statement</span><span class='lparen'>(</span><span class='id identifier rubyid_rows'>rows</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Delete Statement:</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_io'>io</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_format_query'>format_query</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>    </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='ivar'>@table_schema</span><span class='period'>.</span><span class='id identifier rubyid_delete_statement'>delete_statement</span><span class='lparen'>(</span><span class='id identifier rubyid_rows'>rows</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="sleep-instance_method">
  
    - (<tt>Object</tt>) <strong>sleep</strong>(duration) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


201
202
203</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/clean_sweep/purge_runner.rb', line 201</span>

<span class='kw'>def</span> <span class='id identifier rubyid_sleep'>sleep</span> <span class='id identifier rubyid_duration'>duration</span>
  <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span> <span class='id identifier rubyid_duration'>duration</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Dec 17 09:21:51 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.4).
</div>

  </body>
</html>